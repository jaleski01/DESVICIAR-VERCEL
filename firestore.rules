rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Função auxiliar para verificar se o usuário autenticado é o dono dos dados
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Função de Blindagem: Verifica se o usuário está tentando alterar campos restritos
    // Campos nesta lista só podem ser alterados via Firebase Admin (Backend/Webhooks)
    function notUpdatingSensitiveFields() {
      let sensitiveFields = [
        'subscription_status', 
        'plan', 
        'stripeCustomerId', 
        'stripe_customer_id',
        'expirationDate', 
        'subscriptionId', 
        'role', 
        'xp', 
        'level', 
        'created_at', 
        'email'
      ];
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(sensitiveFields);
    }

    // Regras para a coleção principal de usuários
    match /users/{userId} {
      // Permite leitura individual apenas pelo dono para verificar login e assinatura
      allow get: if isOwner(userId);
      
      // Proíbe listagem global de usuários (Privacidade Total)
      allow list: if false;

      /**
       * AUDITORIA DE SEGURANÇA: Bloqueio de Criação Direta
       * O documento do usuário DEVE ser criado via Webhook (Stripe/Admin).
       * Isso impede que usuários criem perfis sem pagamento confirmado.
       */
      allow create: if false;

      /**
       * ATUALIZAÇÃO CONTROLADA:
       * O usuário pode atualizar seu perfil (onboarding, hábitos, etc), 
       * desde que não toque em campos financeiros ou de status.
       */
      allow update: if isOwner(userId) 
        &&切换notUpdatingSensitiveFields()
        // Garante integridade de tipos básicos
        && (request.resource.data.get('addiction_score', 0) is int);

      // Impede deleção de conta via client
      allow delete: if false;

      // Sub-coleção: Histórico de Hábitos (Gestão pelo Usuário)
      match /daily_history/{date} {
        allow read, write: if isOwner(userId);
        
        allow create, update: if request.resource.data.percentage is int
          && request.resource.data.percentage >= 0 
          && request.resource.data.percentage <= 100;
      }

      // Sub-coleção: Logs de Gatilhos (Gestão pelo Usuário)
      match /trigger_logs/{logId} {
        allow read, write: if isOwner(userId);
        
        allow create: if request.resource.data.intensity is int 
          && request.resource.data.intensity >= 1 
          && request.resource.data.intensity <= 5;
      }
    }

    // Bloqueio padrão (Default Deny) para qualquer outro caminho
    match /{path=**} {
      allow read, write: if false;
    }
  }
}